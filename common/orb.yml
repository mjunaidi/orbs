version: 2.1

description: |
  Common commands for building Okode projects
  Repository: https://github.com/okode/orbs

cache-key-npm: &cache-key-npm
  key: cache-npm-{{ arch }}-{{ .Environment.CIRCLE_JOB }}-{{ .Environment.CIRCLE_BRANCH }}-{{ checksum "package-lock.json" }}

cache-key-sonar: &cache-key-sonar
  key: cache-sonar-{{ .Environment.CIRCLE_JOB }}-{{ .Environment.CIRCLE_BRANCH }}-{{ checksum "sonar-project.properties" }}

commands:
  sonar:
    description: "Run Sonar scanner"
    steps:
      - run:
          name: Downloading Sonar scanner
          command: curl -L http://central.maven.org/maven2/org/sonarsource/scanner/cli/sonar-scanner-cli/3.3.0.1492/sonar-scanner-cli-3.3.0.1492.jar > sonar-scanner.jar
      - restore_cache:
          << : *cache-key-sonar
      - run:
          name: Scanning
          command: java -jar sonar-scanner.jar
      - save_cache:
          << : *cache-key-sonar
          paths:
            - ~/.sonar
  npm-install:
    description: "Run npm install"
    steps:
      - restore_cache:
          << : *cache-key-npm
      - run:
          name: Installing NPM dependencies
          command: if [ ! -d "node_modules" ]; then npm ci; fi
      - run:
          name: Restoring package-lock.json
          command: git checkout package-lock.json
      - save_cache:
          << : *cache-key-npm
          paths:
            - node_modules
  node-upgrade:
    description: "Upgrades Node"
    parameters:
      version:
        type: string
        default: "12"
    steps:
      - run:
          name: Upgrading Node version << parameters.version >>
          command: |
            curl -sL https://deb.nodesource.com/setup_<< parameters.version >>.x | sudo -E bash -
            sudo apt-get -qq install -y nodejs
            sudo rm -f /usr/local/bin/node /usr/local/bin/npm /usr/local/bin/npx
            sudo ln -s /usr/bin/node /usr/local/bin
            sudo ln -s /usr/bin/npm /usr/local/bin
            sudo ln -s /usr/bin/npx /usr/local/bin
  chrome-upgrade:
    description: "Upgrades Chrome"
    steps:
      - run:
          name: Upgrading Chrome
          command: |
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
            sudo apt-get update
            sudo apt-get install google-chrome-stable
